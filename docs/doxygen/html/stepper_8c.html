<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>gnea\grbl-Mega: stepper.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Grbl%20Logo%20250px[1].png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">gnea\grbl-Mega
   &#160;<span id="projectnumber">1.0f</span>
   </div>
   <div id="projectbrief">Source Code Documentation ( Internal Workings )</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('stepper_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">stepper.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="grbl_8h_source.html">grbl.h</a>&quot;</code><br />
</div>
<p><a href="stepper_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:structst__block__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#structst__block__t">st_block_t</a></td></tr>
<tr class="memdesc:structst__block__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stores the planner block Bresenham algorithm execution data for the segments in the segment.  <a href="stepper_8c.html#structst__block__t">More...</a><br /></td></tr>
<tr class="separator:structst__block__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structsegment__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#structsegment__t">segment_t</a></td></tr>
<tr class="memdesc:structsegment__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Primary stepper segment ring buffer. Contains small, short line segments for the stepper.  <a href="stepper_8c.html#structsegment__t">More...</a><br /></td></tr>
<tr class="separator:structsegment__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structstepper__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#structstepper__t">stepper_t</a></td></tr>
<tr class="memdesc:structstepper__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stepper ISR data struct. Contains the running data for the main stepper ISR.  <a href="stepper_8c.html#structstepper__t">More...</a><br /></td></tr>
<tr class="separator:structstepper__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structst__prep__t"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#structst__prep__t">st_prep_t</a></td></tr>
<tr class="memdesc:structst__prep__t"><td class="mdescLeft">&#160;</td><td class="mdescRight">Segment preparation data struct. Contains all the necessary information to compute new segments.  <a href="stepper_8c.html#structst__prep__t">More...</a><br /></td></tr>
<tr class="separator:structst__prep__t"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a2649db4c3bd255d66d80a9fc2f6a499c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a2649db4c3bd255d66d80a9fc2f6a499c">DT_SEGMENT</a>&#160;&#160;&#160;(1.0/(<a class="el" href="config_8h.html#ab885db5db397c28aff92477d2d109a62">ACCELERATION_TICKS_PER_SECOND</a>*60.0))</td></tr>
<tr class="memdesc:a2649db4c3bd255d66d80a9fc2f6a499c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Some useful constants.  <a href="#a2649db4c3bd255d66d80a9fc2f6a499c">More...</a><br /></td></tr>
<tr class="separator:a2649db4c3bd255d66d80a9fc2f6a499c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a076b2bcd67b0003d3f07d2b0ebfbba06"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a076b2bcd67b0003d3f07d2b0ebfbba06">REQ_MM_INCREMENT_SCALAR</a>&#160;&#160;&#160;1.25</td></tr>
<tr class="separator:a076b2bcd67b0003d3f07d2b0ebfbba06"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6820c3a92e6dd85f124057a6735f9d18"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a6820c3a92e6dd85f124057a6735f9d18">RAMP_ACCEL</a>&#160;&#160;&#160;0</td></tr>
<tr class="separator:a6820c3a92e6dd85f124057a6735f9d18"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a549a0d8e4c264d8705fbb743d7a2efd5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a549a0d8e4c264d8705fbb743d7a2efd5">RAMP_CRUISE</a>&#160;&#160;&#160;1</td></tr>
<tr class="separator:a549a0d8e4c264d8705fbb743d7a2efd5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50e223c11e7e55921091b182c2373cb9"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a50e223c11e7e55921091b182c2373cb9">RAMP_DECEL</a>&#160;&#160;&#160;2</td></tr>
<tr class="separator:a50e223c11e7e55921091b182c2373cb9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a45754c39031099c6115b0c744c31ecfe"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a45754c39031099c6115b0c744c31ecfe">RAMP_DECEL_OVERRIDE</a>&#160;&#160;&#160;3</td></tr>
<tr class="separator:a45754c39031099c6115b0c744c31ecfe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c9f1cf86f3ef33e48d9ebf86debe22d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a4c9f1cf86f3ef33e48d9ebf86debe22d">PREP_FLAG_RECALCULATE</a>&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(0)</td></tr>
<tr class="separator:a4c9f1cf86f3ef33e48d9ebf86debe22d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab46fdf22bfc2eb9347ff35def23a0c50"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#ab46fdf22bfc2eb9347ff35def23a0c50">PREP_FLAG_HOLD_PARTIAL_BLOCK</a>&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(1)</td></tr>
<tr class="separator:ab46fdf22bfc2eb9347ff35def23a0c50"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67ae84e93e0c70cbe203558315b0727d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a67ae84e93e0c70cbe203558315b0727d">PREP_FLAG_PARKING</a>&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(2)</td></tr>
<tr class="separator:a67ae84e93e0c70cbe203558315b0727d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a21a84d1bff5ba0901f928465fe3e5397"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a21a84d1bff5ba0901f928465fe3e5397">PREP_FLAG_DECEL_OVERRIDE</a>&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(3)</td></tr>
<tr class="separator:a21a84d1bff5ba0901f928465fe3e5397"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19b769968fc5e03eb3c432a0618efb37"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a19b769968fc5e03eb3c432a0618efb37">MAX_AMASS_LEVEL</a>&#160;&#160;&#160;3</td></tr>
<tr class="memdesc:a19b769968fc5e03eb3c432a0618efb37"><td class="mdescLeft">&#160;</td><td class="mdescRight">Define Adaptive Multi-Axis Step-Smoothing(AMASS) levels and cutoff frequencies. The highest level.  <a href="#a19b769968fc5e03eb3c432a0618efb37">More...</a><br /></td></tr>
<tr class="separator:a19b769968fc5e03eb3c432a0618efb37"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a371461474e7a84f455ce5b370b7af755"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a371461474e7a84f455ce5b370b7af755">AMASS_LEVEL1</a>&#160;&#160;&#160;(F_CPU/8000)</td></tr>
<tr class="memdesc:a371461474e7a84f455ce5b370b7af755"><td class="mdescLeft">&#160;</td><td class="mdescRight">Over-drives ISR (x2). Defined as F_CPU/(Cutoff frequency in Hz)  <a href="#a371461474e7a84f455ce5b370b7af755">More...</a><br /></td></tr>
<tr class="separator:a371461474e7a84f455ce5b370b7af755"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9563fceafc6be2957dc5c3e354604c23"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a9563fceafc6be2957dc5c3e354604c23">AMASS_LEVEL2</a>&#160;&#160;&#160;(F_CPU/4000)</td></tr>
<tr class="memdesc:a9563fceafc6be2957dc5c3e354604c23"><td class="mdescLeft">&#160;</td><td class="mdescRight">Over-drives ISR (x4)  <a href="#a9563fceafc6be2957dc5c3e354604c23">More...</a><br /></td></tr>
<tr class="separator:a9563fceafc6be2957dc5c3e354604c23"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae50cefd2cffad5ad95e6823471b7da22"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#ae50cefd2cffad5ad95e6823471b7da22">AMASS_LEVEL3</a>&#160;&#160;&#160;(F_CPU/2000)</td></tr>
<tr class="memdesc:ae50cefd2cffad5ad95e6823471b7da22"><td class="mdescLeft">&#160;</td><td class="mdescRight">Over-drives ISR (x8)  <a href="#ae50cefd2cffad5ad95e6823471b7da22">More...</a><br /></td></tr>
<tr class="separator:ae50cefd2cffad5ad95e6823471b7da22"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:adb4209518cbd433e7521435ce664c588"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#adb4209518cbd433e7521435ce664c588">st_wake_up</a> ()</td></tr>
<tr class="memdesc:adb4209518cbd433e7521435ce664c588"><td class="mdescLeft">&#160;</td><td class="mdescRight">BLOCK VELOCITY PROFILE DEFINITION.  <a href="#adb4209518cbd433e7521435ce664c588">More...</a><br /></td></tr>
<tr class="separator:adb4209518cbd433e7521435ce664c588"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16251b4318ea2a3e12e1992edf43309f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a16251b4318ea2a3e12e1992edf43309f">st_go_idle</a> ()</td></tr>
<tr class="memdesc:a16251b4318ea2a3e12e1992edf43309f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stepper shutdown.  <a href="#a16251b4318ea2a3e12e1992edf43309f">More...</a><br /></td></tr>
<tr class="separator:a16251b4318ea2a3e12e1992edf43309f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad39420cdd896dd12c68e36313139d0a5"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#ad39420cdd896dd12c68e36313139d0a5">ISR</a> (TIMER1_COMPA_vect)</td></tr>
<tr class="memdesc:ad39420cdd896dd12c68e36313139d0a5"><td class="mdescLeft">&#160;</td><td class="mdescRight">"The Stepper Driver Interrupt" - This timer interrupt is the workhorse of Grbl.  <a href="#ad39420cdd896dd12c68e36313139d0a5">More...</a><br /></td></tr>
<tr class="separator:ad39420cdd896dd12c68e36313139d0a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add2d7cdddfb682dcc0391e60cf42c7d6"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#add2d7cdddfb682dcc0391e60cf42c7d6">ISR</a> (TIMER0_OVF_vect)</td></tr>
<tr class="memdesc:add2d7cdddfb682dcc0391e60cf42c7d6"><td class="mdescLeft">&#160;</td><td class="mdescRight">The Stepper Port Reset Interrupt: Timer0 OVF interrupt handles the falling edge of the step pulse. This should always trigger before the next Timer1 COMPA interrupt and independently finish, if Timer1 is disabled after completing a move.  <a href="#add2d7cdddfb682dcc0391e60cf42c7d6">More...</a><br /></td></tr>
<tr class="separator:add2d7cdddfb682dcc0391e60cf42c7d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa05cd55b96bb4c27aab6158dc586e93c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#aa05cd55b96bb4c27aab6158dc586e93c">st_generate_step_dir_invert_masks</a> ()</td></tr>
<tr class="memdesc:aa05cd55b96bb4c27aab6158dc586e93c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generates the step and direction port invert masks used in the Stepper Interrupt Driver.  <a href="#aa05cd55b96bb4c27aab6158dc586e93c">More...</a><br /></td></tr>
<tr class="separator:aa05cd55b96bb4c27aab6158dc586e93c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3fac3b6a1362ae6b3a738d99dfc56bce"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a3fac3b6a1362ae6b3a738d99dfc56bce">st_reset</a> ()</td></tr>
<tr class="memdesc:a3fac3b6a1362ae6b3a738d99dfc56bce"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reset and clear stepper subsystem variables.  <a href="#a3fac3b6a1362ae6b3a738d99dfc56bce">More...</a><br /></td></tr>
<tr class="separator:a3fac3b6a1362ae6b3a738d99dfc56bce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca75476034153603f1b4e76f9f2b7a72"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#aca75476034153603f1b4e76f9f2b7a72">stepper_init</a> ()</td></tr>
<tr class="memdesc:aca75476034153603f1b4e76f9f2b7a72"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize and start the stepper motor subsystem.  <a href="#aca75476034153603f1b4e76f9f2b7a72">More...</a><br /></td></tr>
<tr class="separator:aca75476034153603f1b4e76f9f2b7a72"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5da575c7645401c09b6df0a5a7f31082"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a5da575c7645401c09b6df0a5a7f31082">st_update_plan_block_parameters</a> ()</td></tr>
<tr class="memdesc:a5da575c7645401c09b6df0a5a7f31082"><td class="mdescLeft">&#160;</td><td class="mdescRight">Called by planner_recalculate() when the executing block is updated by the new plan.  <a href="#a5da575c7645401c09b6df0a5a7f31082">More...</a><br /></td></tr>
<tr class="separator:a5da575c7645401c09b6df0a5a7f31082"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab85b0db8fab5c9398f1bef5c4bd3cf83"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#ab85b0db8fab5c9398f1bef5c4bd3cf83">st_prep_buffer</a> ()</td></tr>
<tr class="memdesc:ab85b0db8fab5c9398f1bef5c4bd3cf83"><td class="mdescLeft">&#160;</td><td class="mdescRight">Prepares step segment buffer. Continuously called from main program.  <a href="#ab85b0db8fab5c9398f1bef5c4bd3cf83">More...</a><br /></td></tr>
<tr class="separator:ab85b0db8fab5c9398f1bef5c4bd3cf83"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a23af94f255d66e6503ad671e331eff52"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stepper_8c.html#a23af94f255d66e6503ad671e331eff52">st_get_realtime_rate</a> ()</td></tr>
<tr class="memdesc:a23af94f255d66e6503ad671e331eff52"><td class="mdescLeft">&#160;</td><td class="mdescRight">Called by realtime status reporting to fetch the current speed being executed. This value.  <a href="#a23af94f255d66e6503ad671e331eff52">More...</a><br /></td></tr>
<tr class="separator:a23af94f255d66e6503ad671e331eff52"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<hr/><h2 class="groupheader">Data Structure Documentation</h2>
<a name="structst__block__t" id="structst__block__t"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct st_block_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Stores the planner block Bresenham algorithm execution data for the segments in the segment. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00061">61</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a18b9604e7ecf9badebe112d2924937d6"></a>uint8_t</td>
<td class="fieldname">
direction_bits</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ab6606f705a2b5457600f417d6f3ca100"></a>uint8_t</td>
<td class="fieldname">
is_pwm_rate_adjusted</td>
<td class="fielddoc">
Tracks motions that require constant laser power/rate. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ace8e964b32b5b5391c5b91fbd6800778"></a>uint32_t</td>
<td class="fieldname">
step_event_count</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a6b3c2ad98813739138e40325d7a4bb75"></a>uint32_t</td>
<td class="fieldname">
steps[<a class="el" href="nuts__bolts_8h.html#ad05168a527143ab187f87ef4d77ecdce">N_AXIS</a>]</td>
<td class="fielddoc">
</td></tr>
</table>

</div>
</div>
<a name="structsegment__t" id="structsegment__t"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct segment_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Primary stepper segment ring buffer. Contains small, short line segments for the stepper. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00073">73</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a class="anchor" id="af1c30282d0e97baddbbb14678d7128d9"></a>uint8_t</td>
<td class="fieldname">
amass_level</td>
<td class="fielddoc">
Indicates AMASS level for the ISR to execute this segment. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a6f126e57340823d3962d166942e2e36d"></a>uint16_t</td>
<td class="fieldname">
cycles_per_tick</td>
<td class="fielddoc">
Step distance traveled per ISR tick, aka step rate. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a1a1e477b31677ea9d2f39869bda3c231"></a>uint16_t</td>
<td class="fieldname">
n_step</td>
<td class="fielddoc">
Number of step events to be executed for this segment. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a16849667b42dcdaa24c8d71188d11571"></a>uint16_t</td>
<td class="fieldname">
spindle_pwm</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="af18376ccbae323558eea854a5a98d9de"></a>uint8_t</td>
<td class="fieldname">
st_block_index</td>
<td class="fielddoc">
Stepper block data index. Uses this information to execute this segment. </td></tr>
</table>

</div>
</div>
<a name="structstepper__t" id="structstepper__t"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct stepper_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Stepper ISR data struct. Contains the running data for the main stepper ISR. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00087">87</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ad9ac46e9d05c28f128a3b7ed40ec0a08"></a>uint32_t</td>
<td class="fieldname">
counter_x</td>
<td class="fielddoc">
Counter variables for the bresenham line tracer. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ae9e394d50f631160f6ae2cd03e0c3896"></a>uint32_t</td>
<td class="fieldname">
counter_y</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a3a39200dfd0a7d3b7daa989fc7033f70"></a>uint32_t</td>
<td class="fieldname">
counter_z</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a6d9c8b4e91d45715b3753481ad976d45"></a>uint8_t</td>
<td class="fieldname">
dir_outbits</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a71f642f690a897a521e06455341eef16"></a><a class="el" href="stepper_8c.html#structst__block__t">st_block_t</a> *</td>
<td class="fieldname">
exec_block</td>
<td class="fielddoc">
Pointer to the block data for the segment being executed. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="af8264c97718d505be1c03dec17963681"></a>uint8_t</td>
<td class="fieldname">
exec_block_index</td>
<td class="fielddoc">
Tracks the current st_block index. Change indicates new block. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a8f748e12add0395d419f5aa1c223e276"></a><a class="el" href="stepper_8c.html#structsegment__t">segment_t</a> *</td>
<td class="fieldname">
exec_segment</td>
<td class="fielddoc">
Pointer to the segment being executed. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a65c259ad8b05cb252b0bec8eabd8c867"></a>uint8_t</td>
<td class="fieldname">
execute_step</td>
<td class="fielddoc">
Flags step execution for each interrupt. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a437c555888297135cd157303765ddf41"></a>uint16_t</td>
<td class="fieldname">
step_count</td>
<td class="fielddoc">
Steps remaining in line segment motion. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a8fdbfb692ab26e7d537710118a748c1c"></a>uint8_t</td>
<td class="fieldname">
step_outbits</td>
<td class="fielddoc">
The next stepping-bits to be output. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="aaa5ba82ec5b002f139cd44336936ae49"></a>uint8_t</td>
<td class="fieldname">
step_pulse_time</td>
<td class="fielddoc">
Step pulse reset time after step rise. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ab9e655b75c71d31560080b3fdd127a78"></a>uint32_t</td>
<td class="fieldname">
steps[<a class="el" href="nuts__bolts_8h.html#ad05168a527143ab187f87ef4d77ecdce">N_AXIS</a>]</td>
<td class="fielddoc">
</td></tr>
</table>

</div>
</div>
<a name="structst__prep__t" id="structst__prep__t"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct st_prep_t</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Segment preparation data struct. Contains all the necessary information to compute new segments. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00125">125</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a class="anchor" id="afc9d80fd3dcb40fd0f3c45b5a4d7cc75"></a>float</td>
<td class="fieldname">
accelerate_until</td>
<td class="fielddoc">
Acceleration ramp end measured from end of block (mm) </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a9367d800b76e208675d320d627fcf2de"></a>float</td>
<td class="fieldname">
current_speed</td>
<td class="fielddoc">
Current speed at the end of the segment buffer (mm/min) </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ac2c334475bdfd53bba836189e5466a10"></a>uint16_t</td>
<td class="fieldname">
current_spindle_pwm</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ac03890b14306079112db4e3db5e09860"></a>float</td>
<td class="fieldname">
decelerate_after</td>
<td class="fielddoc">
Deceleration ramp start measured from end of block (mm) </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ab93e654953c8e5a191505443c3e878ac"></a>float</td>
<td class="fieldname">
dt_remainder</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a25a697cc96b7a71b59fe00ae3bd09ba7"></a>float</td>
<td class="fieldname">
exit_speed</td>
<td class="fielddoc">
Exit speed of executing block (mm/min) </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a578b926b9af0210d26cf34fd49699bd7"></a>float</td>
<td class="fieldname">
inv_rate</td>
<td class="fielddoc">
Used by PWM laser mode to speed up segment calculations. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a217e9b2aca0759028a84e14d006a4bce"></a>float</td>
<td class="fieldname">
maximum_speed</td>
<td class="fielddoc">
Maximum speed of executing block. Not always nominal speed. (mm/min) </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a864644512d3995f057c2496942c6f83a"></a>float</td>
<td class="fieldname">
mm_complete</td>
<td class="fielddoc">
End of velocity profile from end of current planner block in (mm). </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="ad3469da4612c7e9dded74f3dd0606e17"></a>uint8_t</td>
<td class="fieldname">
ramp_type</td>
<td class="fielddoc">
Current segment ramp state. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="acc2e3728206f68a025c9abc66a1f4faf"></a>uint8_t</td>
<td class="fieldname">
recalculate_flag</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="afb4cb4666a584075b8005a7a265662f0"></a>float</td>
<td class="fieldname">
req_mm_increment</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="abfdbb839c2a396ee7c4e3e7209ce8bd1"></a>uint8_t</td>
<td class="fieldname">
st_block_index</td>
<td class="fielddoc">
Index of stepper common data block being prepped. </td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a6e02adbe5225c57250e980a341bc17a5"></a>float</td>
<td class="fieldname">
step_per_mm</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a9bb8d9505a6de589ad5333b2513a1909"></a>float</td>
<td class="fieldname">
steps_remaining</td>
<td class="fielddoc">
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="a371461474e7a84f455ce5b370b7af755"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AMASS_LEVEL1&#160;&#160;&#160;(F_CPU/8000)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Over-drives ISR (x2). Defined as F_CPU/(Cutoff frequency in Hz) </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00051">51</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a9563fceafc6be2957dc5c3e354604c23"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AMASS_LEVEL2&#160;&#160;&#160;(F_CPU/4000)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Over-drives ISR (x4) </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00052">52</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae50cefd2cffad5ad95e6823471b7da22"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AMASS_LEVEL3&#160;&#160;&#160;(F_CPU/2000)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Over-drives ISR (x8) </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00053">53</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2649db4c3bd255d66d80a9fc2f6a499c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DT_SEGMENT&#160;&#160;&#160;(1.0/(<a class="el" href="config_8h.html#ab885db5db397c28aff92477d2d109a62">ACCELERATION_TICKS_PER_SECOND</a>*60.0))</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Some useful constants. </p>
<p>min/segment </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00025">25</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a19b769968fc5e03eb3c432a0618efb37"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_AMASS_LEVEL&#160;&#160;&#160;3</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Define Adaptive Multi-Axis Step-Smoothing(AMASS) levels and cutoff frequencies. The highest level. </p>
<p>frequency bin starts at 0Hz and ends at its cutoff frequency. The next lower level frequency bin starts at the next higher cutoff frequency, and so on. The cutoff frequencies for each level must be considered carefully against how much it over-drives the stepper ISR, the accuracy of the 16-bit timer, and the CPU overhead. Level 0 (no AMASS, normal operation) frequency bin starts at the Level 1 cutoff frequency and up to as fast as the CPU allows (over 30kHz in limited testing).</p>
<dl class="section note"><dt>Note</dt><dd>AMASS cutoff frequency multiplied by ISR overdrive factor must not exceed maximum step frequency.</dd>
<dd>
Current settings are set to overdrive the ISR to no more than 16kHz, balancing CPU overhead and timer accuracy. Do not alter these settings unless you know what you are doing. </dd></dl>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00049">49</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a21a84d1bff5ba0901f928465fe3e5397"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PREP_FLAG_DECEL_OVERRIDE&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(3)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00035">35</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab46fdf22bfc2eb9347ff35def23a0c50"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PREP_FLAG_HOLD_PARTIAL_BLOCK&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(1)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00033">33</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a67ae84e93e0c70cbe203558315b0727d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PREP_FLAG_PARKING&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(2)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00034">34</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a4c9f1cf86f3ef33e48d9ebf86debe22d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PREP_FLAG_RECALCULATE&#160;&#160;&#160;<a class="el" href="nuts__bolts_8h.html#a62fe4f31d7cd6087317744dd800a86c3">bit</a>(0)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00032">32</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a6820c3a92e6dd85f124057a6735f9d18"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RAMP_ACCEL&#160;&#160;&#160;0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00027">27</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a549a0d8e4c264d8705fbb743d7a2efd5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RAMP_CRUISE&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00028">28</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a50e223c11e7e55921091b182c2373cb9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RAMP_DECEL&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00029">29</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a45754c39031099c6115b0c744c31ecfe"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RAMP_DECEL_OVERRIDE&#160;&#160;&#160;3</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00030">30</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a076b2bcd67b0003d3f07d2b0ebfbba06"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define REQ_MM_INCREMENT_SCALAR&#160;&#160;&#160;1.25</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00026">26</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ad39420cdd896dd12c68e36313139d0a5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ISR </td>
          <td>(</td>
          <td class="paramtype">TIMER1_COMPA_vect&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>"The Stepper Driver Interrupt" - This timer interrupt is the workhorse of Grbl. </p>
<p>Grbl employs the venerable Bresenham line algorithm to manage and exactly synchronize multi-axis moves. Unlike the popular DDA algorithm, the Bresenham algorithm is not susceptible to numerical round-off errors and only requires fast integer counters, meaning low computational overhead and maximizing the Arduino's capabilities.</p>
<p>However, the downside of the Bresenham algorithm is, for certain multi-axis motions, the non-dominant axes may suffer from un-smooth step pulse trains, or aliasing, which can lead to strange audible noises or shaking. This is particularly noticeable or may cause motion issues at low step frequencies (0-5kHz), but is usually not a physical problem at higher frequencies, although audible.</p>
<p>To improve Bresenham multi-axis performance, Grbl uses what we call an Adaptive Multi-Axis Step Smoothing (AMASS) algorithm, which does what the name implies. At lower step frequencies, AMASS artificially increases the Bresenham resolution without effecting the algorithm's innate exactness. AMASS adapts its resolution levels automatically depending on the step frequency to be executed, meaning that for even lower step frequencies the step smoothing level increases. Algorithmically, AMASS is acheived by a simple bit-shifting of the Bresenham step count for each AMASS level.</p>
<p>For example, for a Level 1 step smoothing, we bit shift the Bresenham step event count, effectively multiplying it by 2, while the axis step counts remain the same, and then double the stepper ISR frequency. In effect, we are allowing the non-dominant Bresenham axes step in the intermediate ISR tick, while the dominant axis is stepping every two ISR ticks, rather than every ISR tick in the traditional sense.</p>
<p>At AMASS Level 2, we simply bit-shift again, so the non-dominant Bresenham axes can step within any of the four ISR ticks, the dominant axis steps every four ISR ticks, and quadruple the stepper ISR frequency. And so on. This, in effect, virtually eliminates multi-axis aliasing issues with the Bresenham algorithm and does not significantly alter Grbl's performance, but in fact, more efficiently utilizes unused CPU cycles overall throughout all configurations.</p>
<p>AMASS retains the Bresenham algorithm exactness by requiring that it always executes a full Bresenham step, regardless of AMASS Level. Meaning that for an AMASS Level 2, all four intermediate steps must be completed such that baseline Bresenham (Level 0) count is always retained. Similarly, AMASS Level 3 means all eight intermediate steps must be executed. Although the AMASS Levels are in reality arbitrary, where the baseline Bresenham counts can be multiplied by any integer value, multiplication by powers of two are simply used to ease CPU overhead with bitshift integer operations.</p>
<p>This interrupt is simple and dumb by design. All the computational heavy-lifting, as in determining accelerations, is performed elsewhere. This interrupt pops pre-computed segments, defined as constant velocity over n number of steps, from the step segment buffer and then executes them by pulsing the stepper pins appropriately via the Bresenham algorithm. This ISR is supported by The Stepper Port Reset Interrupt which it uses to reset the stepper port after each pulse. The bresenham line tracer algorithm controls all stepper outputs simultaneously with these two interrupts.</p>
<dl class="section note"><dt>Note</dt><dd>This interrupt must be as efficient as possible and complete before the next ISR tick, which for Grbl must be less than 33.3usec (@30kHz ISR rate). Oscilloscope measured time in ISR is 5usec typical and 25usec maximum, well below requirement.</dd>
<dd>
This ISR expects at least one step to be executed per segment.</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000012">Todo:</a></b></dt><dd>Replace direct updating of the int32 position counters in the ISR somehow. Perhaps use smaller int8 variables and update position counters only when a segment completes. This can get complicated with probing and homing cycles that require true real-time positions. </dd></dl>
<p>&lt; </p><dl class="section note"><dt>Note</dt><dd>Can sometimes be zero when moving slow.</dd></dl>
<p>&lt; Flag main program for cycle end</p>
<p>&lt; Nothing to do but exit.</p>
<p>&lt; Decrement step events count</p>
<p>&lt; Apply step port invert mask </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00304">304</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="add2d7cdddfb682dcc0391e60cf42c7d6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ISR </td>
          <td>(</td>
          <td class="paramtype">TIMER0_OVF_vect&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The Stepper Port Reset Interrupt: Timer0 OVF interrupt handles the falling edge of the step pulse. This should always trigger before the next Timer1 COMPA interrupt and independently finish, if Timer1 is disabled after completing a move. </p>
<dl class="section note"><dt>Note</dt><dd>Interrupt collisions between the serial and stepper interrupts can cause delays by a few microseconds, if they execute right before one another. Not a big deal, but can cause issues at high step rates if another high frequency asynchronous interrupt is added to Grbl.</dd>
<dd>
This interrupt is enabled by ISR_TIMER1_COMPAREA when it sets the motor port bits to execute a step. This ISR resets the motor port after a short period (settings.pulse_microseconds) completing one step cycle. </dd></dl>
<p>&lt; Disable Timer0 to prevent re-entering this interrupt when it's not needed. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00444">444</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="aa05cd55b96bb4c27aab6158dc586e93c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void st_generate_step_dir_invert_masks </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Generates the step and direction port invert masks used in the Stepper Interrupt Driver. </p>
<p>Generate the step and direction port invert masks. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00464">464</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a23af94f255d66e6503ad671e331eff52"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float st_get_realtime_rate </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Called by realtime status reporting to fetch the current speed being executed. This value. </p>
<p>Called by realtime status reporting if realtime rate reporting is enabled in <a class="el" href="config_8h.html">config.h</a>. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l01001">1001</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a16251b4318ea2a3e12e1992edf43309f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void st_go_idle </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stepper shutdown. </p>
<p>Immediately disables steppers. </p>
<p>&lt; Disable Timer1 interrupt</p>
<p>&lt; Reset clock to no prescaling.</p>
<p>&lt; Keep enabled.</p>
<p>&lt; Override. Disable steppers. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00224">224</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab85b0db8fab5c9398f1bef5c4bd3cf83"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void st_prep_buffer </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Prepares step segment buffer. Continuously called from main program. </p>
<p>Reloads step segment buffer. Called continuously by realtime execution system.</p>
<p>The segment buffer is an intermediary buffer interface between the execution of steps by the stepper algorithm and the velocity profiles generated by the planner. The stepper algorithm only executes steps within the segment buffer and is filled by the main program when steps are "checked-out" from the first block in the planner buffer. This keeps the step execution and planning optimization processes atomic and protected from each other. The number of steps "checked-out" from the planner buffer and the number of segments in the segment buffer is sized and computed such that no operation in the main program takes longer than the time it takes the stepper algorithm to empty it before refilling it. Currently, the segment buffer conservatively holds roughly up to 40-50 msec of steps. </p><dl class="section note"><dt>Note</dt><dd>Computation units are in steps, millimeters, and minutes. </dd></dl>
<p>&lt; Check if we need to fill the buffer.</p>
<p>&lt; Reset for new segment block</p>
<p>&lt; Default velocity profile complete at 0.0mm from end of block.</p>
<p>&lt; [Forced Deceleration to Zero Velocity]</p>
<p>&lt; End of feed hold.</p>
<p>&lt; [Normal Operation]</p>
<p>&lt; Initialize as acceleration ramp.</p>
<p>&lt; Enforce stop at end of system motion.</p>
<p>&lt; Only occurs during override reductions.</p>
<p>&lt; Deceleration-only.</p>
<p>&lt; Flag to load next block as deceleration override.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000013">Todo:</a></b></dt><dd>Determine correct handling of parameters in deceleration-only. </dd></dl>
<p>&lt; Either trapezoid or triangle types</p>
<p>&lt; Trapezoid type</p>
<p>&lt; Triangle type</p>
<p>&lt; Deceleration-only type</p>
<p>&lt; Acceleration-only type</p>
<p>&lt; Force update whenever updating block.</p>
<p>&lt; Maximum segment time</p>
<p>&lt; Initialize segment time</p>
<p>&lt; Time worker variable</p>
<p>&lt; mm-Distance worker variable</p>
<p>&lt; Speed worker variable</p>
<p>&lt; New segment distance from end of block.</p>
<p>&lt; Guarantee at least one step.</p>
<p>&lt; </p><dl class="section note"><dt>Note</dt><dd>0.0 at EOB</dd></dl>
<p>&lt; Mid-deceleration override ramp.</p>
<p>&lt; End of acceleration ramp.</p>
<p>&lt; </p><dl class="section note"><dt>Note</dt><dd>0.0 at EOB</dd></dl>
<p>&lt; Acceleration only.</p>
<p>&lt; End of cruise.</p>
<p>&lt; </p><dl class="section note"><dt>Note</dt><dd>0.0 at EOB</dd></dl>
<p>&lt; Cruising only.</p>
<p>&lt; case RAMP_DECEL:</p>
<p>&lt; Used as delta speed (mm/min)</p>
<p>&lt; Check if at or below zero speed.</p>
<p>&lt; (mm)</p>
<p>&lt; Typical case. In deceleration ramp.</p>
<p>&lt; Segment complete. Exit switch-case statement. Continue do-while loop.</p>
<p>&lt; Add computed ramp time to total segment time.</p>
<p>&lt; Check for very slow segments with zero steps.</p>
<p>&lt; <b>Complete</b> Exit loop. Segment execution time maxed.</p>
<p>&lt; <b>Complete</b> Exit loop. Profile complete.</p>
<p>&lt; Reload segment PWM value</p>
<p>&lt; Convert mm_remaining to steps</p>
<p>&lt; Round-up current steps remaining</p>
<p>&lt; Round-up last steps remaining</p>
<p>&lt; Compute number of steps to execute.</p>
<p>&lt; Segment not generated, but current step data still retained.</p>
<p>&lt; Apply previous segment partial step execute time</p>
<p>&lt; Compute adjusted step rate inverse</p>
<p>&lt; (cycles/step)</p>
<p>&lt; At end of forced-termination.</p>
<p>&lt; Bail!</p>
<p>&lt; End of planner block</p>
<p>&lt; Set pointer to indicate check and load next planner block. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00594">594</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a3fac3b6a1362ae6b3a738d99dfc56bce"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void st_reset </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reset and clear stepper subsystem variables. </p>
<p>Reset the stepper subsystem variables. </p>
<p>&lt; Planner block pointer used by segment buffer</p>
<p>&lt; empty = tail</p>
<p>&lt; Initialize direction bits to default. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00476">476</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="a5da575c7645401c09b6df0a5a7f31082"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void st_update_plan_block_parameters </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Called by planner_recalculate() when the executing block is updated by the new plan. </p>
<p>&lt; Ignore if at start of a new block.</p>
<p>&lt; Update entry speed.</p>
<p>&lt; Flag st_prep_segment() to load and check active velocity profile. </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00526">526</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="adb4209518cbd433e7521435ce664c588"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void st_wake_up </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>BLOCK VELOCITY PROFILE DEFINITION. </p>
<p>Enable steppers, but cycle does not start unless called by motion control or realtime command.</p>
<pre>
          __________________________
         /|                        |\     _________________         ^
        / |                        | \   /|               |\        |
       /  |                        |  \ / |               | \       s
      /   |                        |   |  |               |  \      p
     /    |                        |   |  |               |   \     e
    +-----+------------------------+---+--+---------------+----+    e
    |               BLOCK 1            ^      BLOCK 2          |    d
                                       |
                  time -----&gt;      EXAMPLE: Block 2 entry speed is at max junction velocity
</pre><p> The planner block buffer is planned assuming constant acceleration velocity profiles and are continuously joined at block junctions as shown above. However, the planner only actively computes the block entry speeds for an optimal velocity plan, but does not compute the block internal velocity profiles. These velocity profiles are computed ad-hoc as they are executed by the stepper algorithm and consists of only 7 possible types of profiles: cruise-only, cruise- deceleration, acceleration-cruise, acceleration-only, deceleration-only, full-trapezoid, and triangle(no cruise). </p><pre></pre><pre>                                        maximum_speed (&lt; nominal_speed) -&gt;  +
                    +--------+ &lt;- maximum_speed (= nominal_speed)          /|\
                   /          \                                           / | \
 current_speed -&gt; +            \                                         /  |  + &lt;- exit_speed
                  |             + &lt;- exit_speed                         /   |  |
                  +-------------+                     current_speed -&gt; +----+--+
                   time --&gt;  ^  ^                                           ^  ^
                             |  |                                           |  |
                decelerate_after(in mm)                             decelerate_after(in mm)
                    ^           ^                                           ^  ^
                    |           |                                           |  |
                accelerate_until(in mm)                             accelerate_until(in mm)
</pre><p> The step segment buffer computes the executing block velocity profile and tracks the critical parameters for the stepper algorithm to accurately trace the profile. These critical parameters are shown and defined in the above illustration.Stepper state initialization. Cycle should only start if the st.cycle_start flag is </p>
<p>&lt; Normal operation </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00199">199</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
<a class="anchor" id="aca75476034153603f1b4e76f9f2b7a72"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stepper_init </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize and start the stepper motor subsystem. </p>
<p>Initialize and setup the stepper motor subsystem. </p>
<p>&lt; waveform generation = 0100 = CTC</p>
<p>&lt; Disconnect OC1 output</p>
<p>&lt; Disconnect OC0 outputs and OVF interrupt.</p>
<p>&lt; Normal operation</p>
<p>&lt; Disable Timer0 until needed</p>
<p>&lt; Enable Timer0 overflow interrupt </p>

<p>Definition at line <a class="el" href="stepper_8c_source.html#l00500">500</a> of file <a class="el" href="stepper_8c_source.html">stepper.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_16af47fdf13b652490b4f721f0228326.html">grbl</a></li><li class="navelem"><a class="el" href="stepper_8c.html">stepper.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
