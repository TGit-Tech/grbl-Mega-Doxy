<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>gnea\grbl-Mega: motion_control.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Grbl%20Logo%20250px[1].png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">gnea\grbl-Mega
   &#160;<span id="projectnumber">1.0f</span>
   </div>
   <div id="projectbrief">Source Code Documentation ( Internal Workings )</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('motion__control_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">motion_control.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="grbl_8h_source.html">grbl.h</a>&quot;</code><br />
</div>
<p><a href="motion__control_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aedbe6e3c01bd13e5c26b08d53eadadf0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#aedbe6e3c01bd13e5c26b08d53eadadf0">mc_line</a> (float *target, <a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *<a class="el" href="gcode_8c.html#a6a8a4abb31e881b8b50fe72bd8933073">pl_data</a>)</td></tr>
<tr class="memdesc:aedbe6e3c01bd13e5c26b08d53eadadf0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Execute linear motion in absolute millimeter coordinates. Feed rate given in millimeters/second.  <a href="#aedbe6e3c01bd13e5c26b08d53eadadf0">More...</a><br /></td></tr>
<tr class="separator:aedbe6e3c01bd13e5c26b08d53eadadf0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf1beb5a15dd4029445e72d1792331a6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#abf1beb5a15dd4029445e72d1792331a6">mc_arc</a> (float *target, <a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *<a class="el" href="gcode_8c.html#a6a8a4abb31e881b8b50fe72bd8933073">pl_data</a>, float *position, float *offset, float radius, uint8_t axis_0, uint8_t axis_1, uint8_t axis_linear, uint8_t is_clockwise_arc)</td></tr>
<tr class="memdesc:abf1beb5a15dd4029445e72d1792331a6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Execute an arc in offset mode format. position == current xyz, target == target xyz,.  <a href="#abf1beb5a15dd4029445e72d1792331a6">More...</a><br /></td></tr>
<tr class="separator:abf1beb5a15dd4029445e72d1792331a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae430cf188773869d06de5bd262efed6e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#ae430cf188773869d06de5bd262efed6e">mc_dwell</a> (float seconds)</td></tr>
<tr class="memdesc:ae430cf188773869d06de5bd262efed6e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Execute dwell in seconds.  <a href="#ae430cf188773869d06de5bd262efed6e">More...</a><br /></td></tr>
<tr class="separator:ae430cf188773869d06de5bd262efed6e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65ba55d3a79e565b952f6a72d3080b9c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#a65ba55d3a79e565b952f6a72d3080b9c">mc_homing_cycle</a> (uint8_t cycle_mask)</td></tr>
<tr class="memdesc:a65ba55d3a79e565b952f6a72d3080b9c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Perform homing cycle to locate and set machine zero. Only '$H' executes this command.  <a href="#a65ba55d3a79e565b952f6a72d3080b9c">More...</a><br /></td></tr>
<tr class="separator:a65ba55d3a79e565b952f6a72d3080b9c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a66db82c68c77e04996365f5525742769"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#a66db82c68c77e04996365f5525742769">mc_probe_cycle</a> (float *target, <a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *<a class="el" href="gcode_8c.html#a6a8a4abb31e881b8b50fe72bd8933073">pl_data</a>, uint8_t parser_flags)</td></tr>
<tr class="memdesc:a66db82c68c77e04996365f5525742769"><td class="mdescLeft">&#160;</td><td class="mdescRight">Perform tool length probe cycle. Requires probe switch.  <a href="#a66db82c68c77e04996365f5525742769">More...</a><br /></td></tr>
<tr class="separator:a66db82c68c77e04996365f5525742769"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19f4e778cc8edfc10685637f5b9e4217"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#a19f4e778cc8edfc10685637f5b9e4217">mc_parking_motion</a> (float *parking_target, <a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *<a class="el" href="gcode_8c.html#a6a8a4abb31e881b8b50fe72bd8933073">pl_data</a>)</td></tr>
<tr class="memdesc:a19f4e778cc8edfc10685637f5b9e4217"><td class="mdescLeft">&#160;</td><td class="mdescRight">Plans and executes the single special motion case for parking. Independent of main planner buffer.  <a href="#a19f4e778cc8edfc10685637f5b9e4217">More...</a><br /></td></tr>
<tr class="separator:a19f4e778cc8edfc10685637f5b9e4217"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3dbbc7ba62d6fc62bc04d94e1889540"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="motion__control_8c.html#af3dbbc7ba62d6fc62bc04d94e1889540">mc_reset</a> ()</td></tr>
<tr class="memdesc:af3dbbc7ba62d6fc62bc04d94e1889540"><td class="mdescLeft">&#160;</td><td class="mdescRight">Method to ready the system to reset by setting the realtime reset command and killing any.  <a href="#af3dbbc7ba62d6fc62bc04d94e1889540">More...</a><br /></td></tr>
<tr class="separator:af3dbbc7ba62d6fc62bc04d94e1889540"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="abf1beb5a15dd4029445e72d1792331a6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mc_arc </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *&#160;</td>
          <td class="paramname"><em>pl_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>position</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>radius</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>axis_0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>axis_1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>axis_linear</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>is_clockwise_arc</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Execute an arc in offset mode format. position == current xyz, target == target xyz,. </p>
<p>&lt; Radius vector from center to current location</p>
<p>&lt; Correct atan2 output per direction</p>
<p>NOTE: Segment end points are on the arc, which can lead to the arc diameter being smaller by up to</p>
<p>&lt; Force as feed absolute mode over arc segments.</p>
<p>Vector rotation by transformation matrix: r is the original vector, r_T is the rotated vector, and phi is the angle of rotation. Solution approach by Jens Geisler. r_T = [cos(phi) -sin(phi); sin(phi) cos(phi] * r ;</p>
<p>For arc generation, the center of the circle is the axis of rotation and the radius vector is defined from the circle center to the initial position. Each line segment is formed by successive vector rotations. Single precision values can accumulate error greater than tool precision in rare cases. So, exact arc path correction is implemented. This approach avoids the problem of too many very expensive trig operations [sin(),cos(),tan()] which can take 100-200 usec each to compute.</p>
<p>Small angle approximation may be used to reduce computation overhead further. A third-order approximation (second order sin() has too much error) holds for most, if not, all CNC applications. Note that this approximation will begin to accumulate a numerical drift error when theta_per_segment is greater than ~0.25 rad(14 deg) AND the approximation is successively used without correction several dozen times. This scenario is extremely unlikely, since segment lengths and theta_per_segment are automatically generated and scaled by the arc tolerance setting. Only a very large arc tolerance setting, unrealistic for CNC applications, would cause this numerical drift error. However, it is best to set N_ARC_CORRECTION from a low of ~4 to a high of ~20 or so to avoid trig operations while keeping arc generation accurate.</p>
<p>This approximation also allows mc_arc to immediately insert a line segment into the planner without the initial overhead of computing cos() or sin(). By the time the arc needs to be applied a correction, the planner should have caught up to the lag caused by the initial mc_arc overhead. This is important when there are successive arc motions.</p>
<p>&lt; Increment (segments-1). </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00082">82</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae430cf188773869d06de5bd262efed6e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mc_dwell </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>seconds</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Execute dwell in seconds. </p>
<p>Dwell for a specific number of seconds. </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00190">190</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
<a class="anchor" id="a65ba55d3a79e565b952f6a72d3080b9c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mc_homing_cycle </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>cycle_mask</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Perform homing cycle to locate and set machine zero. Only '$H' executes this command. </p>
<p>Perform homing cycle to locate machine zero. Requires limit switches.</p>
<p>NOTE: There should be no motions in the buffer and Grbl must be in an idle state before </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Move the pin-specific LIMIT_PIN call to <a class="el" href="limits_8c.html">limits.c</a> as a function. </dd></dl>
<p>&lt; Disable hard limits pin change register for cycle duration</p>
<p>NOTE: Special motion case. Only system reset works.</p>
<p>&lt; Homing cycle 0</p>
<p>&lt; Homing cycle 1</p>
<p>&lt; Check for reset and set system abort. </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00201">201</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
<a class="anchor" id="aedbe6e3c01bd13e5c26b08d53eadadf0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mc_line </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *&#160;</td>
          <td class="paramname"><em>pl_data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Execute linear motion in absolute millimeter coordinates. Feed rate given in millimeters/second. </p>
<p>NOTE: This is the primary gateway to the grbl planner. All line motions, including arc line </p>
<p>NOTE: Block jog state. Jogging is a special case and soft limits are handled independently.</p>
<p>NOTE: Backlash compensation may be installed here. It will need direction info to track when</p>
<p>NOTE: Perhaps as a middle-ground, all that needs to be sent is a flag or special command that</p>
<p>&lt; Check for any run-time commands </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00032">32</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
<a class="anchor" id="a19f4e778cc8edfc10685637f5b9e4217"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mc_parking_motion </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>parking_target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *&#160;</td>
          <td class="paramname"><em>pl_data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Plans and executes the single special motion case for parking. Independent of main planner buffer. </p>
<p>NOTE: Uses the always free planner ring buffer head to store motion parameters for execution. </p>
<p>&lt; Allow parking motion to execute, if feed hold is active.</p>
<p>&lt; Setup step segment buffer for special parking motion case</p>
<p>&lt; Restore step segment buffer to normal run state. </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00320">320</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
<a class="anchor" id="a66db82c68c77e04996365f5525742769"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t mc_probe_cycle </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="planner_8h.html#structplan__line__data__t">plan_line_data_t</a> *&#160;</td>
          <td class="paramname"><em>pl_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>parser_flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Perform tool length probe cycle. Requires probe switch. </p>
<p>NOTE: Upon probe failure, the program will be stopped and placed into ALARM state. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd>Need to update this cycle so it obeys a non-auto cycle start. </dd></dl>
<p>&lt; Re-initialize probe history before beginning cycle.</p>
<p>NOTE: This probe initialization error applies to all probing cycles.</p>
<p>&lt; Check probe pin state.</p>
<p>&lt; Re-initialize invert mask before returning.</p>
<p>&lt; Nothing else to do but bail.</p>
<p>&lt; Indicate to system the probing cycle completed successfully.</p>
<p>&lt; Ensure probe state monitor is disabled.</p>
<p>&lt; Re-initialize invert mask.</p>
<p>&lt; Check and execute run-time commands</p>
<p>&lt; Reset step segment buffer.</p>
<p>&lt; Reset planner buffer. Zero planner positions. Ensure probing motion is cleared.</p>
<p>&lt; Sync planner position to current machine position. </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00252">252</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
<a class="anchor" id="af3dbbc7ba62d6fc62bc04d94e1889540"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mc_reset </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Method to ready the system to reset by setting the realtime reset command and killing any. </p>
<p>Performs system reset. If in motion state, kills all motion and sets system alarm. </p>
<p>NOTE: If steppers are kept enabled via the step idle delay setting, this also keeps</p>
<p>&lt; Force kill steppers. Position has likely been lost. </p>

<p>Definition at line <a class="el" href="motion__control_8c_source.html#l00349">349</a> of file <a class="el" href="motion__control_8c_source.html">motion_control.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_16af47fdf13b652490b4f721f0228326.html">grbl</a></li><li class="navelem"><a class="el" href="motion__control_8c.html">motion_control.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
